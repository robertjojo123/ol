-- ‚úÖ Placer Turtle Settings
local blockDataBaseUrl = "https://raw.githubusercontent.com/robertjojo123/olympus2/refs/heads/main/output_"
local totalFiles = 122
local startIndex = 1

-- ‚úÖ Function: Wait for Previous Worker Turtle to be Removed
local function waitForTurtleRemoval()
    while turtle.detect() do
        print("‚è≥ Waiting for previous Worker Turtle to be removed...")
        sleep(2)
    end
end

-- ‚úÖ Function: Place and Setup New Worker Turtle
local function deployWorker(turtleIndex)
    print("üì¶ Placing Worker Turtle for `output_" .. turtleIndex .. ".lua`")

    -- Wait until there's space
    waitForTurtleRemoval()

    -- Place the Worker Turtle
    if not turtle.place() then
        print("‚ùå ERROR: Failed to place Worker Turtle!")
        return
    end

    -- Sleep to allow Turtle to initialize
    sleep(2)

    -- Wrap the Worker Turtle and confirm it exists
    local worker = peripheral.wrap("front")
    if not worker then
        print("‚ùå ERROR: Could not detect placed Worker Turtle!")
        return
    end

    -- ‚úÖ Write a command inside the Worker Turtle to `wget` the correct `output_X.lua`
    local wgetScript = [[
    if fs.exists("output.lua") then fs.delete("output.lua") end
    print("üì• Downloading block data: ]] .. blockDataBaseUrl .. turtleIndex .. [[.lua")
    shell.run("wget ]] .. blockDataBaseUrl .. turtleIndex .. [[.lua output.lua")
    if fs.exists("output.lua") then
        print("‚úÖ Downloaded block data successfully!")
    else
        print("‚ùå ERROR: Failed to download block data!")
    end
    ]]
    local wgetFile = fs.open("front/wget_blockdata.lua", "w")
    wgetFile.write(wgetScript)
    wgetFile.close()

    -- ‚úÖ Create a script inside the Worker Turtle to copy `startup.lua` from the Disk Drive after wget
    local copyScript = [[
    shell.run("wget_blockdata.lua")
    if fs.exists("/disk/startup.lua") then
        fs.copy("/disk/startup.lua", "/startup")
        print("‚úÖ Copied `startup.lua` from Disk Drive.")
    else
        print("‚ùå ERROR: No `startup.lua` found on disk!")
    end
    os.reboot()
    ]]
    local copyFile = fs.open("front/startup", "w")
    copyFile.write(copyScript)
    copyFile.close()

    -- ‚úÖ Confirm Worker Turtle can respond before proceeding
    print("‚è≥ Waiting for Worker Turtle to acknowledge setup...")
    sleep(3)

    print("üîÑ Worker Turtle setup complete! Rebooting...")
end

-- ‚úÖ Main Loop: Deploy Worker Turtles Sequentially
for i = startIndex, totalFiles do
    deployWorker(i)
    print("‚úÖ Worker Turtle #" .. i .. " is now running! Waiting for removal before placing the next one...")
    waitForTurtleRemoval() -- Wait before placing the next Turtle
end

print("üéâ All Worker Turtles deployed!")
