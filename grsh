-- âœ… Function Declarations
local waitForFile, loadBlockData, startBuild, buildSchematic, moveTo, saveProgress, refuelTurtle, restock, placeBlock

-- âœ… Position Tracking (Default Start Position)
local pos = {x = -5, y = 0, z = 0, dir = 0}
local lastPlacedIndex = 1

-- âœ… Debugging: Show that the script has started
print("ğŸš€ Worker Turtle Booting Up...")

-- âœ… Function: Check if `output.lua` Exists
local function checkForOutputFile()
    local attempts = 0
    while not fs.exists("output.lua") do
        print("â³ Waiting for `output.lua`...")
        sleep(1)
        attempts = attempts + 1
        if attempts > 30 then
            print("âŒ ERROR: `output.lua` not found after 30 seconds. Shutting down.")
            os.shutdown()
        end
    end
    print("âœ… `output.lua` Detected!")
end

-- âœ… Function: Load Block Data
loadBlockData = function()
    checkForOutputFile()
    print("ğŸ“¥ Loading `output.lua`...")
    local chunk = loadfile("output.lua")
    if chunk then
        local success, data = pcall(chunk)
        if success and type(data) == "table" then
            print("âœ… Block data loaded successfully!")
            return data
        end
    end
    print("âŒ ERROR: Could not load output.lua")
    return nil
end

-- âœ… Save Progress
saveProgress = function()
    local file = fs.open("progress.json", "w")
    file.write(textutils.serialize({ lastPlacedIndex = lastPlacedIndex }))
    file.close()
    print("ğŸ’¾ Progress Saved!")
end

-- âœ… Move to Target Position
moveTo = function(target)
    if not target then return end
    print("ğŸš¶ Moving to X=" .. target.x .. " Y=" .. target.y .. " Z=" .. target.z)

    while pos.x ~= target.x do
        if pos.x < target.x then turtle.turnRight() else turtle.turnLeft() end
        if turtle.forward() then
            pos.x = pos.x + (pos.dir == 1 and 1 or -1)
        else
            print("â›” Blocked! Can't move forward.")
            return false
        end
    end

    while pos.z ~= target.z do
        if pos.z < target.z then turtle.turnLeft() else turtle.turnRight() end
        if turtle.forward() then
            pos.z = pos.z + (pos.dir == 0 and 1 or -1)
        else
            print("â›” Blocked! Can't move forward.")
            return false
        end
    end

    while pos.y < target.y do
        if turtle.up() then pos.y = pos.y + 1 else print("â›” Blocked! Can't go up.") return false end
    end
    while pos.y > target.y do
        if turtle.down() then pos.y = pos.y - 1 else print("â›” Blocked! Can't go down.") return false end
    end

    print("âœ… Arrived at destination.")
    return true
end

-- âœ… Restock Blocks from Material Chests
restock = function(block)
    local blockID = "minecraft:" .. block
    local chests = {
        {x = -9, y = 0, z = -4, dir = 2},
        {x = -9, y = 1, z = -4, dir = 2}
    }

    print("ğŸ”„ Restocking " .. blockID .. "...")

    for _, chest in ipairs(chests) do
        if moveTo(chest) then
            turtle.turnLeft()
            if turtle.suck(64) then 
                print("âœ… Restocked " .. blockID .. "!")
                return true
            end
        end
    end
    print("âŒ Failed to restock " .. blockID)
    return false
end

-- âœ… Place Block and Move Forward
placeBlock = function(block)
    local blockID = "minecraft:" .. block
    for i = 1, 16 do
        local item = turtle.getItemDetail(i)
        if item and item.name == blockID then
            turtle.select(i)
            if turtle.placeDown() then
                print("âœ… Placed:", blockID)
                if not turtle.forward() then return false end
                return true
            end
        end
    end
    return false
end

-- âœ… Build Process
buildSchematic = function(data)
    if not data or #data == 0 then
        print("âŒ ERROR: Block data is empty!")
        return
    end

    print("ğŸ› ï¸ Starting Build Process...")

    for i = lastPlacedIndex, #data do
        local block = data[i]
        if block and block.block then
            print("ğŸ”¨ Placing:", block.block, "at", block.x, block.y, block.z)
            if moveTo({x = block.x, y = block.y, z = block.z}) then
                if placeBlock(block.block) then
                    lastPlacedIndex = i + 1
                    saveProgress()
                else
                    print("âš ï¸ Failed to place " .. block.block .. ", trying again.")
                    sleep(2)
                end
            else
                print("âš ï¸ Can't reach " .. block.x .. ", " .. block.y .. ", " .. block.z)
            end
        end
    end

    print("âœ… Build complete!")
end

-- âœ… Start Build Process
startBuild = function()
    print("ğŸš€ Starting Build Process...")
    local blockData = loadBlockData()
    if blockData then
        buildSchematic(blockData)
    else
        print("âŒ ERROR: No valid block data found!")
    end

    print("ğŸ”´ Build complete. Shutting down...")
    os.shutdown()
end

-- âœ… Ensure Build Starts Automatically
startBuild()
