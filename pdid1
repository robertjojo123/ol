-- âœ… Placer Turtle Settings
local blockDataBaseUrl = "https://raw.githubusercontent.com/robertjojo123/olympus2/refs/heads/main/output_"
local totalFiles = 122
local startIndex = 1

-- âœ… Function: Wait for Previous Worker Turtle to be Removed
local function waitForTurtleRemoval()
    while turtle.detect() do
        print("â³ Waiting for previous Worker Turtle to be removed...")
        sleep(2)
    end
end

-- âœ… Function: Execute a command inside the Worker Turtle
local function runCommandOnWorker(command)
    local worker = peripheral.wrap("front")
    if not worker then
        print("âŒ ERROR: Worker Turtle not detected!")
        return false
    end
    local commandFile = fs.open("front/worker_command.lua", "w")
    commandFile.write(command)
    commandFile.close()
    worker.run("worker_command.lua")  -- Worker Turtle executes the written command
    return true
end

-- âœ… Function: Place and Setup New Worker Turtle
local function deployWorker(turtleIndex)
    print("ğŸ“¦ Placing Worker Turtle for `output_" .. turtleIndex .. ".lua`")

    -- Wait until there's space
    waitForTurtleRemoval()

    -- Place the Worker Turtle
    if not turtle.place() then
        print("âŒ ERROR: Failed to place Worker Turtle!")
        return
    end

    -- Sleep to allow Turtle to initialize
    sleep(2)

    -- âœ… Tell Worker Turtle to `wget` the correct `output_X.lua`
    print("ğŸ“¥ Instructing Worker Turtle to download block data...")
    local wgetCommand = "shell.run('wget " .. blockDataBaseUrl .. turtleIndex .. ".lua output.lua')"
    if not runCommandOnWorker(wgetCommand) then
        print("âŒ ERROR: Worker Turtle failed to download `output_" .. turtleIndex .. ".lua`")
        return
    end

    -- âœ… Tell Worker Turtle to copy `startup.lua` from Disk Drive
    print("ğŸ“‚ Instructing Worker Turtle to copy `startup.lua`...")
    if not runCommandOnWorker("shell.run('cp /disk/startup.lua /startup')") then
        print("âŒ ERROR: Worker Turtle failed to copy `startup.lua` from Disk!")
        return
    end

    -- âœ… Tell Worker Turtle to reboot
    print("ğŸ”„ Instructing Worker Turtle to reboot...")
    if not runCommandOnWorker("os.reboot()") then
        print("âŒ ERROR: Worker Turtle failed to reboot!")
        return
    end

    print("âœ… Worker Turtle setup complete!")
end

-- âœ… Main Loop: Deploy Worker Turtles Sequentially
for i = startIndex, totalFiles do
    deployWorker(i)
    print("âœ… Worker Turtle #" .. i .. " is now running! Waiting for removal before placing the next one...")
    waitForTurtleRemoval() -- Wait before placing the next Turtle
end

print("ğŸ‰ All Worker Turtles deployed!")
